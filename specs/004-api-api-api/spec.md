# Feature Specification: API密钥管理与外部API服务

**Feature Branch**: `004-api-api-api`
**Created**: 2025-10-16
**Status**: Draft
**Input**: User description: "当前项目我需要提供对外API服务，用户可以创建API密钥，API密钥创建的时候可以选择所有的网站，可以指定网站。对外服务接口有如下：生成账号密码（通过对外服务的接口，创建的密码的密码长度和安全性无需检测，直接写入数据库，但是不能为空）、删除账号密码、账号禁用或者启用（账号禁用和启用的这个功能目前缺失，需要加入该功能）"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - API密钥管理 (Priority: P1) 🎯 MVP

用户需要创建API密钥以便外部系统或脚本能够调用AccountBox的API接口。用户可以为API密钥指定访问范围：要么访问所有网站的账号数据,要么只访问特定网站的账号数据。这样可以实现细粒度的权限控制,保证外部系统只能访问其被授权的数据。

**Why this priority**: 这是提供对外API服务的基础前提。没有API密钥管理,就无法安全地提供外部API服务。API密钥的作用域控制(全部网站vs指定网站)是核心安全功能,可以防止权限泄露。

**Independent Test**: 用户可以独立测试API密钥的创建、查看、删除功能。验证：(1) 创建API密钥时可以选择"所有网站"或"指定网站"；(2) 创建后可以看到密钥明文(仅一次)和脱敏后的密钥；(3) 可以删除不再使用的API密钥；(4) 创建时指定了作用域的密钥,其权限被正确记录。

**Acceptance Scenarios**:

1. **Given** 用户已登录并进入API密钥管理页面，**When** 点击"创建API密钥"按钮，**Then** 打开创建对话框,显示名称输入框和作用域选择器(单选框:"所有网站" 或 "指定网站")
2. **Given** 用户选择"所有网站"作为作用域，**When** 填写密钥名称并提交，**Then** 系统生成API密钥,显示密钥明文(提示仅显示一次),并保存密钥的哈希值和作用域信息
3. **Given** 用户选择"指定网站"作为作用域，**When** 从下拉列表中选择3个网站并提交，**Then** 系统生成API密钥,仅授权该密钥访问这3个网站的账号数据
4. **Given** 用户已创建5个API密钥，**When** 访问API密钥列表页面，**Then** 显示所有密钥的名称、作用域(所有网站 / 指定网站列表)、创建时间、最后使用时间,密钥值显示为脱敏格式(如"sk_••••••••••••1234")
5. **Given** 用户在API密钥列表页面，**When** 点击某个密钥的"删除"按钮并确认，**Then** 该密钥被删除,后续使用该密钥调用API会返回401未授权错误
6. **Given** 用户创建API密钥后关闭了密钥明文显示窗口，**When** 再次查看该密钥，**Then** 只能看到脱敏后的密钥值,无法再次查看明文(需要重新生成)

---

### User Story 2 - 账号启用/禁用功能 (Priority: P2)

用户需要能够暂时禁用某个账号而不删除它。禁用的账号不会在账号列表中正常显示,外部API也无法获取禁用账号的信息。当需要恢复使用时,用户可以重新启用该账号。这为账号生命周期管理提供了更灵活的控制。

**Why this priority**: 这是核心数据管理功能的增强。虽然删除功能已存在(且有回收站),但很多场景下用户只是想临时停用某个账号(如测试账号、过期凭证),而不是永久删除。此功能独立于API服务,也可服务于UI用户。

**Independent Test**: 在账号列表页面,用户可以独立测试账号的禁用和启用操作。验证：(1) 点击"禁用"按钮后,账号状态变为"已禁用",在默认列表中不显示；(2) 切换到"显示已禁用账号"视图,可以看到被禁用的账号；(3) 点击"启用"按钮后,账号恢复正常状态并重新出现在默认列表中。

**Acceptance Scenarios**:

1. **Given** 用户在某网站的账号列表页面,当前有10个活跃账号，**When** 点击某账号的"禁用"按钮，**Then** 该账号状态变为"已禁用",从默认列表中隐藏,活跃账号数量显示为9
2. **Given** 账号列表中有3个已禁用账号，**When** 用户勾选"显示已禁用账号"复选框，**Then** 列表显示所有账号(活跃+禁用),已禁用账号用灰色背景或特殊图标标识
3. **Given** 用户在"显示已禁用账号"视图中，**When** 点击某个已禁用账号的"启用"按钮，**Then** 该账号恢复活跃状态,重新出现在默认列表中
4. **Given** 用户禁用了某个账号，**When** 通过外部API尝试获取该网站的账号列表，**Then** 响应中不包含已禁用的账号
5. **Given** 用户尝试禁用某账号，**When** 该账号是该网站下唯一的活跃账号，**Then** 系统允许禁用(不像删除那样需要保留至少一个账号)
6. **Given** 用户在回收站中恢复了一个之前被删除的账号，**When** 账号恢复后，**Then** 账号默认处于"已禁用"状态,需要用户手动启用才能使用

---

### User Story 3 - 外部API：创建账号密码 (Priority: P3)

外部系统可以通过API接口为指定网站创建新的账号密码记录。调用时需提供API密钥、网站ID、用户名、密码等必要信息。密码字段不能为空,但无需进行长度或安全强度检测,系统直接将密码存储到数据库中。

**Why this priority**: 这是外部API服务的核心功能之一,允许自动化工具或脚本批量创建账号。由于用户已明确表示"通过API创建的密码无需安全检测",这简化了实现。此功能依赖于User Story 1的API密钥,因此优先级较低。

**Independent Test**: 使用curl或Postman等工具,携带有效的API密钥调用创建账号接口。验证：(1) 提供完整的必填字段后成功创建账号；(2) 密码为空时返回400错误；(3) API密钥作用域为"指定网站"时,只能为授权网站创建账号,访问未授权网站返回403错误；(4) 创建的账号在UI中可见。

**Acceptance Scenarios**:

1. **Given** 外部系统持有作用域为"所有网站"的API密钥，**When** 调用创建账号接口,提供网站ID、用户名、密码(非空)，**Then** 系统成功创建账号,返回201状态码和账号详情
2. **Given** 外部系统调用创建账号接口，**When** 密码字段为空字符串或null，**Then** 系统返回400错误,提示"密码不能为空"
3. **Given** 外部系统调用创建账号接口，**When** 提供的密码为"123"(弱密码)，**Then** 系统仍然成功创建账号,不进行密码强度验证(符合用户要求)
4. **Given** 外部系统持有作用域为"网站A、网站B"的API密钥，**When** 尝试为网站C创建账号，**Then** 系统返回403错误,提示"API密钥无权访问该网站"
5. **Given** 外部系统调用创建账号接口，**When** 提供的网站ID不存在，**Then** 系统返回404错误,提示"网站不存在"
6. **Given** 外部系统成功创建账号后，**When** 用户在UI中查看该网站的账号列表，**Then** 新创建的账号出现在列表中,且状态为"活跃"

---

### User Story 4 - 外部API：删除账号密码 (Priority: P4)

外部系统可以通过API接口删除指定的账号密码记录。删除操作遵循与UI相同的规则：账号被移入回收站而不是立即永久删除,用户可以在30天内恢复。API密钥的作用域限制同样适用。

**Why this priority**: 这是外部API服务的补充功能,允许自动化清理过期或无效账号。由于删除是敏感操作,优先级低于创建。此功能复用现有的删除逻辑(回收站机制),实现相对简单。

**Independent Test**: 使用curl或Postman等工具,携带有效的API密钥调用删除账号接口。验证：(1) 成功删除账号后,该账号进入回收站；(2) API密钥作用域限制正确工作；(3) 删除后再次查询该账号返回404或标记为已删除。

**Acceptance Scenarios**:

1. **Given** 外部系统持有有效的API密钥且有权访问网站A，**When** 调用删除账号接口,提供账号ID，**Then** 系统将账号移入回收站,返回204状态码
2. **Given** 外部系统调用删除账号接口，**When** 账号已被移入回收站，**Then** 系统返回404错误,提示"账号不存在"
3. **Given** 外部系统持有作用域为"网站A"的API密钥，**When** 尝试删除网站B的账号，**Then** 系统返回403错误,提示"API密钥无权访问该网站的账号"
4. **Given** 外部系统成功删除账号后，**When** 用户在UI中查看该网站的账号列表，**Then** 该账号不再出现,但在回收站中可见
5. **Given** 外部系统调用删除账号接口，**When** 提供的账号ID不存在，**Then** 系统返回404错误,提示"账号不存在"

---

### User Story 5 - 外部API：账号启用/禁用 (Priority: P5)

外部系统可以通过API接口启用或禁用指定的账号。这允许外部工具自动化地管理账号生命周期,例如定期禁用过期凭证或批量启用测试账号。

**Why this priority**: 这是对User Story 2的API扩展,为外部系统提供与UI相同的账号状态管理能力。由于依赖于User Story 2的基础功能,且属于批量操作优化,优先级最低。

**Independent Test**: 使用curl或Postman等工具,携带有效的API密钥调用账号启用/禁用接口。验证：(1) 成功禁用账号后,该账号状态变为"已禁用"；(2) 成功启用账号后,状态恢复为"活跃"；(3) 禁用后再次调用获取账号列表接口,已禁用账号不包含在默认响应中。

**Acceptance Scenarios**:

1. **Given** 外部系统持有有效的API密钥，**When** 调用禁用账号接口,提供账号ID，**Then** 系统将账号状态设为"已禁用",返回200状态码
2. **Given** 外部系统调用启用账号接口，**When** 账号当前处于"已禁用"状态，**Then** 系统将账号状态恢复为"活跃",返回200状态码
3. **Given** 外部系统禁用了某账号，**When** 调用获取账号列表接口(不带特殊参数)，**Then** 响应中不包含该已禁用账号
4. **Given** 外部系统调用获取账号列表接口，**When** 添加查询参数`includeDisabled=true`，**Then** 响应中包含活跃和已禁用的所有账号
5. **Given** 外部系统调用禁用账号接口，**When** 账号已处于"已禁用"状态，**Then** 系统返回200(幂等操作),账号保持禁用状态

---

### Edge Cases

- **API密钥泄露**：如果用户的API密钥被泄露,恶意调用者可能滥用API接口。系统是否需要提供密钥轮换(重新生成)功能？(假设：初期不提供,用户可以删除旧密钥并创建新密钥)
- **API密钥作用域变更**：用户创建API密钥后,是否可以修改其作用域(如从"网站A"改为"网站A、B、C")？(假设：不支持修改,需要删除并重新创建)
- **并发请求**：多个外部系统同时使用同一API密钥调用创建账号接口,为同一网站创建同名账号,系统如何处理？(假设：不检查账号名重复,允许创建,由用户自行管理)
- **速率限制**：外部系统是否可以无限制地调用API接口？(假设：初期不实施速率限制,未来可根据需要添加)
- **API密钥过期**：API密钥是否有有效期？(假设：密钥永久有效,除非用户主动删除)
- **禁用账号的编辑**：用户是否可以编辑已禁用的账号(如修改密码、备注)？(假设：可以编辑,禁用只影响可见性和API访问,不影响编辑权限)
- **批量操作**：外部API是否支持批量创建、删除、启用/禁用多个账号？(假设：初期不支持,每次操作一个账号,未来可扩展)
- **密钥明文丢失**：用户创建API密钥后未保存密钥明文,是否可以重新查看或重置？(假设：不可重新查看,用户需要删除旧密钥并创建新密钥)

## Requirements *(mandatory)*

### Functional Requirements

**API密钥管理**:

- **FR-001**: 系统必须允许用户创建API密钥,并为每个密钥生成唯一的密钥字符串(如"sk_"前缀 + 32位随机字符)
- **FR-002**: 系统必须在API密钥创建时显示密钥明文(仅一次),之后仅显示脱敏格式(如"sk_••••••••••••1234")
- **FR-003**: 系统必须存储API密钥的哈希值而非明文,用于后续验证
- **FR-004**: 用户必须能够为API密钥指定作用域:"所有网站" 或 "指定网站列表"
- **FR-005**: 系统必须验证API调用时提供的密钥是否有权访问目标网站(基于密钥的作用域)
- **FR-006**: 系统必须允许用户删除不再使用的API密钥
- **FR-007**: 系统必须在API密钥列表中显示每个密钥的名称、作用域、创建时间、最后使用时间

**账号启用/禁用功能**:

- **FR-008**: 系统必须为Account实体添加"状态"字段,支持"活跃(Active)"和"已禁用(Disabled)"两种状态
- **FR-009**: 用户必须能够在账号列表页面禁用某个账号,禁用后该账号从默认列表中隐藏
- **FR-010**: 用户必须能够启用已禁用的账号,使其恢复为活跃状态
- **FR-011**: 系统必须提供"显示已禁用账号"的选项(如复选框或过滤器),允许用户查看所有账号
- **FR-012**: 已禁用账号在列表中必须有明显的视觉标识(如灰色背景、禁用图标)
- **FR-013**: 从回收站恢复的账号必须默认处于"已禁用"状态,需要用户手动启用

**外部API：创建账号密码**:

- **FR-014**: 系统必须提供RESTful API接口,允许外部系统创建账号密码记录
- **FR-015**: API接口必须验证请求中包含有效的API密钥,无密钥或密钥无效时返回401错误
- **FR-016**: API接口必须验证API密钥是否有权访问目标网站,无权限时返回403错误
- **FR-017**: API接口创建账号时,密码字段不能为空,为空时返回400错误
- **FR-018**: API接口创建账号时,不进行密码长度或安全强度验证,直接存储到数据库
- **FR-019**: API接口成功创建账号后,返回201状态码和账号详情(包括账号ID、用户名、创建时间等)

**外部API：删除账号密码**:

- **FR-020**: 系统必须提供RESTful API接口,允许外部系统删除账号密码记录
- **FR-021**: API接口删除账号时,遵循与UI相同的规则:将账号移入回收站而非永久删除
- **FR-022**: API接口必须验证API密钥是否有权访问目标账号所属的网站

**外部API：账号启用/禁用**:

- **FR-023**: 系统必须提供RESTful API接口,允许外部系统启用或禁用账号
- **FR-024**: API接口禁用账号后,后续的"获取账号列表"API调用不包含已禁用账号(除非明确指定`includeDisabled=true`参数)
- **FR-025**: API接口启用/禁用操作是幂等的:多次禁用已禁用账号、多次启用已启用账号,均返回成功

**通用安全要求**:

- **FR-026**: 所有API接口必须使用HTTPS协议(生产环境)
- **FR-027**: 系统必须记录所有API调用日志,包括API密钥ID、调用时间、操作类型、目标资源
- **FR-028**: API接口必须返回标准的HTTP状态码和错误消息(如400、401、403、404、500等)

### Key Entities

- **ApiKey(API密钥)**: 表示用户创建的API密钥,包含密钥哈希值、名称、作用域类型(全部/指定)、关联的网站列表、创建时间、最后使用时间
- **Account(账号)**: 扩展现有的账号实体,添加"状态"字段(活跃/已禁用),其余属性保持不变(用户名、密码、所属网站、标签、备注等)
- **ApiKeyWebsiteScope(API密钥网站作用域)**: 当API密钥作用域为"指定网站"时,记录该密钥可访问的网站列表(多对多关系)

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户可以在30秒内完成API密钥的创建,包括选择作用域和保存密钥明文
- **SC-002**: 用户禁用或启用账号的操作响应时间低于1秒,状态变更立即反映在UI中
- **SC-003**: 外部系统通过API创建账号的成功率达到99%(假设网络正常、参数正确)
- **SC-004**: API接口调用的平均响应时间低于500毫秒(在正常负载下)
- **SC-005**: 系统支持至少100个并发API请求而不出现性能下降
- **SC-006**: API密钥作用域验证的准确率为100%,未授权的API调用100%返回403错误
- **SC-007**: 用户可以通过API密钥管理界面,在5秒内找到并删除特定的API密钥
- **SC-008**: 已禁用账号不出现在默认的账号列表API响应中,准确率100%
- **SC-009**: 从回收站恢复的账号100%默认为"已禁用"状态,需要用户手动启用
- **SC-010**: API接口的错误消息清晰明了,95%的开发者能够根据错误消息快速定位问题
