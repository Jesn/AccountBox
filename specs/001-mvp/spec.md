# Feature Specification: 账号管理系统 MVP

**Feature Branch**: `001-mvp`
**Created**: 2025-10-14
**Status**: Draft
**Input**: User description: "最小 MVP 需求（更新项：网站删除与回收站）..."

---

## ⚠️ 重要架构变更说明（2025-10-17）

**本规范中的加密系统设计（User Story 6 和 FR-036 至 FR-043）已不再适用于当前版本。**

系统已从**加密存储模式**切换为**明文存储模式**：
- ✅ 密码直接以明文形式存储在数据库中
- ✅ 移除了所有加密相关组件（VaultKey, KeySlot, Argon2, AES-GCM）
- ✅ 简化了系统架构，适用于个人自托管场景

**为什么保留这些内容？**
本规范记录了项目的历史设计，保留原文有助于理解项目演进过程。

**当前版本请参考：**
- `/specs/ENCRYPTION_REMOVAL_SUMMARY.md` - 架构变更总结
- `/specs/006-api-management/spec.md` - 最新功能规范（已反映明文存储架构）
- `/Augment-Memories.md` - 项目记忆库（已更新架构变更记录）

---

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 管理网站和账号 (Priority: P1)

用户需要一个集中位置来管理所有网站的账号信息。他们能够创建网站条目（如"GitHub"、"Gmail"），并在每个网站下添加多个账号，记录用户名、密码、备注和标签等信息。

**Why this priority**: 这是整个系统的核心价值主张——如果用户无法添加和查看账号，系统就失去了存在的意义。

**Independent Test**: 用户可以完整地创建一个网站、在该网站下添加账号、查看账号列表、编辑账号信息、查看网站列表，这构成了一个完整的可用功能切片。

**Acceptance Scenarios**:

1. **Given** 用户首次使用系统, **When** 用户创建一个新网站（如"GitHub.com"）并添加域名、显示名和标签, **Then** 网站成功创建并显示在网站列表中
2. **Given** 网站已存在, **When** 用户在该网站下添加一个账号（用户名、密码、备注、标签）, **Then** 账号成功保存并显示在该网站的账号列表中
3. **Given** 网站列表有多个条目, **When** 用户浏览网站列表, **Then** 列表以每页10条的形式展示，可翻页查看更多
4. **Given** 某网站下有多个账号, **When** 用户打开该网站的账号列表, **Then** 账号以每页10条的形式展示，可翻页查看
5. **Given** 账号已存在, **When** 用户修改账号的任何信息（用户名、密码、备注、标签）, **Then** 修改成功保存
6. **Given** 网站已存在, **When** 用户修改网站的任何信息（域名、显示名、标签）, **Then** 修改成功保存

---

### User Story 2 - 安全删除账号（软删除与回收站） (Priority: P2)

用户有时需要删除不再使用的账号，但希望有"后悔药"——能够从回收站恢复误删的账号。删除的账号不会立即从系统中物理移除，而是移入回收站，用户可以在回收站中查看、恢复或永久删除这些账号。

**Why this priority**: 这是数据安全的重要保障，防止用户误操作造成数据永久丢失。虽然不如P1核心，但对于密码管理器这类数据敏感系统，回收站功能显著提升用户信心。

**Independent Test**: 用户可以删除账号、在回收站中查看被删除的账号、恢复账号、或永久删除账号。这个功能不依赖其他高级特性即可独立测试和使用。

**Acceptance Scenarios**:

1. **Given** 账号存在于某个网站下, **When** 用户删除该账号, **Then** 账号不再出现在正常的账号列表中，但出现在回收站中
2. **Given** 账号在回收站中, **When** 用户在系统设置/回收站页面查看, **Then** 显示所有软删除的账号（分页展示，每页10条）
3. **Given** 账号在回收站中, **When** 用户选择恢复该账号, **Then** 账号重新出现在原网站的账号列表中，并从回收站移除
4. **Given** 账号在回收站中, **When** 用户选择永久删除该账号, **Then** 账号从系统中彻底移除，无法恢复
5. **Given** 回收站中有多个账号, **When** 用户点击"一键清空回收站", **Then** 系统显示二次确认对话框，确认后所有回收站账号被永久删除
6. **Given** 回收站中有来自多个网站的账号, **When** 用户选择按网站筛选, **Then** 只显示属于该网站的软删除账号

---

### User Story 3 - 安全删除网站（级联删除保护） (Priority: P2)

当用户想要删除某个网站条目时，系统需要确保不会意外删除该网站下仍在使用的账号。只有当网站下所有账号都已被软删除（移入回收站）后，才允许删除网站。如果回收站中还有该网站的账号，删除前会提示用户，避免数据丢失。

**Why this priority**: 这是防止数据批量丢失的关键保护机制。虽然不如核心CRUD功能重要，但对于防止用户误操作至关重要，应在MVP中包含。

**Independent Test**: 用户可以尝试删除有活跃账号的网站（被阻止）、尝试删除只有回收站账号的网站（收到警告）、以及成功删除没有任何账号的网站。

**Acceptance Scenarios**:

1. **Given** 网站下有至少一个未被软删除的账号, **When** 用户尝试删除该网站, **Then** 系统阻止删除并提示"需先删除或移至回收站所有账号"
2. **Given** 网站下所有账号都已软删除（在回收站中）, **When** 用户尝试删除该网站, **Then** 系统显示确认对话框："回收站还有 N 条账号，删除网站将永久删除这些账号"
3. **Given** 用户看到上述确认对话框, **When** 用户确认删除, **Then** 网站被删除，该网站下所有账号（包括回收站中的）被物理删除
4. **Given** 网站下没有任何账号（包括回收站）, **When** 用户删除该网站, **Then** 网站直接删除，无需额外确认

---

### User Story 4 - 搜索账号 (Priority: P2)

用户可能管理数百个账号，需要快速找到特定的账号信息。用户在搜索框输入关键词并按回车后，系统会在网站名、域名、用户名、标签、备注等字段中搜索，返回匹配的结果列表。

**Why this priority**: 搜索功能对于账号管理器的可用性至关重要，但系统没有搜索功能仍可基本使用（通过浏览列表）。因此优先级略低于P1。

**Independent Test**: 用户可以在搜索框输入关键词、按回车触发搜索、查看分页结果、翻页查看更多结果。

**Acceptance Scenarios**:

1. **Given** 系统中存在多个网站和账号, **When** 用户在搜索框输入关键词并按回车, **Then** 系统返回所有匹配的账号（匹配网站显示名、域名、用户名、标签、备注字段）
2. **Given** 搜索词包含大小写字母, **When** 用户提交搜索, **Then** 搜索不区分大小写
3. **Given** 搜索词包含首尾空格, **When** 用户提交搜索, **Then** 系统自动去除首尾空格后进行搜索
4. **Given** 搜索结果超过10条, **When** 用户查看搜索结果, **Then** 结果分页展示（每页10条），可翻页查看
5. **Given** 系统中有软删除的账号, **When** 用户执行搜索, **Then** 默认搜索结果不包含已软删除的账号
6. **Given** 用户在第2页搜索结果中, **When** 用户修改搜索词并提交新搜索, **Then** 从第1页开始显示新的搜索结果

---

### User Story 5 - 生成强密码 (Priority: P3)

用户在创建或修改账号时，可以使用内置的密码生成器来创建强密码。生成器允许用户配置密码长度、选择字符集（大写字母、小写字母、数字、符号），并可排除易混淆的字符。生成的密码会显示强度指示，用户可以重新生成或接受当前密码。

**Why this priority**: 密码生成器提升了用户体验和安全性，但用户也可以手动输入密码，因此这是一个"nice to have"功能，优先级相对较低。

**Independent Test**: 用户可以打开密码生成器、配置生成参数、生成密码、查看强度、重新生成、接受并将密码填充到表单中。

**Acceptance Scenarios**:

1. **Given** 用户正在创建或编辑账号, **When** 用户点击密码字段旁的"生成密码"按钮, **Then** 打开密码生成器界面
2. **Given** 密码生成器已打开, **When** 用户配置长度和字符集选项（大写/小写/数字/符号/排除易混淆字符）, **Then** 生成器立即生成符合配置的密码
3. **Given** 密码已生成, **When** 用户查看生成的密码, **Then** 显示密码强度指示（如：弱/中/强）
4. **Given** 密码已生成, **When** 用户点击"重新生成"按钮, **Then** 基于当前配置生成新的密码
5. **Given** 用户对生成的密码满意, **When** 用户点击"接受"按钮, **Then** 密码填充到账号表单的密码字段，生成器关闭
6. **Given** 密码填充到表单中, **When** 用户未点击保存按钮, **Then** 密码仅存在于表单中，不会写入存储

---

### User Story 6 - 本地加密存储 (Priority: P1)

用户的所有敏感数据（账号、密码）必须使用强加密算法在本地加密存储，确保即使设备被盗或存储文件被窃取，攻击者也无法读取数据。系统使用信封加密机制：业务数据由随机生成的VaultKey加密，VaultKey本身由用户主密码派生的密钥加密。

**Why this priority**: 安全性是密码管理器的生命线。没有加密存储，系统不可用于生产环境。这是P1优先级的基础设施功能。

**Independent Test**: 系统首次运行时，用户设置主密码；系统生成VaultKey并使用主密码派生的密钥加密它；后续用户每次使用时输入主密码解锁；所有业务数据读写均通过VaultKey加密/解密。

**Acceptance Scenarios**:

1. **Given** 用户首次使用系统, **When** 用户设置主密码, **Then** 系统生成随机256-bit VaultKey，使用主密码派生的KEK加密VaultKey并持久化KeySlot
2. **Given** 系统已初始化, **When** 用户添加或修改账号数据, **Then** 数据使用VaultKey通过AES-256-GCM加密后存储
3. **Given** 用户重启应用, **When** 用户输入主密码, **Then** 系统使用主密码派生KEK，解密KeySlot获取VaultKey，VaultKey加载到内存中
4. **Given** 用户想要修改主密码, **When** 用户输入旧密码和新密码, **Then** 系统使用新密码派生新KEK，重新包裹VaultKey生成新KeySlot，业务数据无需重新加密
5. **Given** VaultKey在内存中, **When** 用户读取账号数据, **Then** 系统使用VaultKey解密数据后展示给用户
6. **Given** 应用运行中, **When** 系统进行任何操作, **Then** VaultKey仅存在于内存中，不会被写入磁盘或日志

---

### Edge Cases

- **边界条件**：
  - 当网站列表或账号列表恰好为10、20等整数倍页数时，分页是否正确显示？
  - 当用户在最后一页删除最后一条记录后，是否自动回退到上一页？
  - 当搜索结果为空时，如何友好地提示用户？

- **错误场景**：
  - 当用户输入错误的主密码时，系统如何提示并限制尝试次数？
  - 当回收站为空时点击"一键清空"，系统如何响应？
  - 当用户尝试创建重复域名的网站时，系统是否允许（假设：允许，因为可能有测试/正式环境等多个同域名网站）？
  - 当网络站点或账号的名称包含特殊字符时（如<script>标签），系统如何安全处理？

- **并发场景**：
  - 多个窗口/标签页同时打开系统时，数据同步如何处理？（假设：单用户本地应用，不考虑多端同步）

- **数据完整性**：
  - 当用户在删除网站确认对话框中点击确认时，如果此时系统崩溃，是否会出现网站已删除但账号未删除的不一致状态？

## Requirements *(mandatory)*

### Functional Requirements

**网站管理**：

- **FR-001**: 系统必须允许用户创建网站条目，包含域名、显示名、标签字段
- **FR-002**: 系统必须允许用户编辑已存在的网站条目的任何字段
- **FR-003**: 系统必须允许用户删除网站条目（遵循FR-014至FR-017的删除规则）
- **FR-004**: 系统必须以分页方式展示网站列表，默认每页10条记录，按创建时间倒序排列（最新创建的在前）
- **FR-005**: 系统必须允许用户在网站列表中翻页浏览所有网站

**账号管理**：

- **FR-006**: 系统必须允许用户在某个网站下创建账号，包含用户名、密码、备注、标签字段
- **FR-007**: 系统必须允许用户编辑账号的任何字段
- **FR-008**: 系统必须将账号关联到唯一的父网站
- **FR-009**: 系统必须以分页方式展示某网站下的账号列表，默认每页10条记录，按用户名字母顺序排列
- **FR-010**: 系统必须允许用户在账号列表中翻页浏览该网站的所有账号

**软删除与回收站**：

- **FR-011**: 系统必须在用户删除账号时执行软删除操作（标记为已删除，而非物理删除）
- **FR-012**: 系统必须在默认的账号列表和搜索结果中隐藏已软删除的账号
- **FR-013**: 系统必须在"系统设置/回收站"页面展示所有已软删除的账号（分页展示，每页10条）
- **FR-014**: 系统必须仅在网站下活跃账号数为0时才允许删除该网站（活跃=未软删除）
- **FR-015**: 系统必须在删除网站前检查回收站中是否存在该网站的已删除账号，如存在则显示确认对话框："回收站还有 N 条账号，删除网站将永久删除这些账号"
- **FR-016**: 系统必须在用户确认删除网站后，物理删除该网站及其所有关联账号（包括回收站中的软删除账号）
- **FR-017**: 系统必须在网站下存在活跃账号时阻止删除操作，并提示用户"需先删除或移至回收站所有账号"
- **FR-018**: 系统必须允许用户从回收站恢复单个账号到原网站
- **FR-019**: 系统必须允许用户从回收站永久删除单个账号
- **FR-020**: 系统必须提供"一键清空回收站"功能，显示二次确认对话框后永久删除回收站中所有账号
- **FR-021**: 系统必须允许用户在回收站中按网站筛选，仅显示特定网站的已删除账号

**搜索功能**：

- **FR-022**: 系统必须在用户按下回车键时触发搜索操作
- **FR-023**: 系统必须在以下字段中搜索关键词：网站显示名、域名、账号用户名、账号标签、账号备注
- **FR-024**: 系统必须对搜索关键词进行大小写不敏感匹配
- **FR-025**: 系统必须在执行搜索前自动去除关键词的首尾空格
- **FR-026**: 系统必须在搜索结果中默认排除已软删除的账号
- **FR-027**: 系统必须以分页方式展示搜索结果，每页10条，并显示总记录数
- **FR-028**: 系统必须在用户翻页或提交新搜索时向后端请求数据（后端分页）

**密码生成器**：

- **FR-029**: 系统必须提供密码生成器功能，允许用户配置密码长度
- **FR-030**: 系统必须允许用户选择密码字符集：大写字母、小写字母、数字、符号
- **FR-031**: 系统必须允许用户选择排除易混淆字符（如0/O, 1/l/I）
- **FR-032**: 系统必须在生成密码后显示密码强度指示
- **FR-033**: 系统必须允许用户重新生成密码
- **FR-034**: 系统必须在用户接受生成的密码后，将其填充到当前账号表单的密码字段
- **FR-035**: 系统必须仅在用户明确保存账号表单时才将密码持久化到存储

**本地加密存储**：

- **FR-036**: 系统必须在首次初始化时生成随机的256-bit VaultKey
- **FR-037**: 系统必须使用AES-256-GCM算法和VaultKey加密所有业务数据（网站、账号信息），且VaultKey仅驻留在内存中，不得写入磁盘或日志
- **FR-038**: 系统必须使用用户主密码通过Argon2id KDF派生KEK（密钥加密密钥）
- **FR-039**: 系统必须使用KEK加密VaultKey，并将加密后的VaultKey持久化为KeySlot
- **FR-040**: 系统必须在用户修改主密码时，使用新主密码派生新KEK，重新包裹VaultKey生成新KeySlot
- **FR-041**: 系统必须在修改主密码时无需重新加密业务数据
- **FR-042**: 系统必须在应用启动时要求用户输入主密码以解密KeySlot并获取VaultKey
- **FR-043**: 系统必须在用户连续5次输入错误主密码后锁定解锁功能30分钟，防止暴力破解攻击

### Key Entities

- **网站（Website）**: 代表一个在线服务或平台，包含：
  - 域名（如 github.com）
  - 显示名称（如 GitHub）
  - 标签（用于分类，如"开发"、"社交"）
  - 关联的账号列表

- **账号（Account）**: 代表用户在某个网站上的登录凭证，包含：
  - 用户名
  - 密码（加密存储）
  - 备注（可选，如"工作账号"）
  - 标签（用于分类）
  - 软删除状态（是否在回收站中）
  - 所属网站的引用

- **回收站（RecycleBin）**: 一个逻辑视图，展示所有已软删除的账号，支持：
  - 列出所有软删除账号
  - 按网站筛选
  - 恢复或永久删除操作

- **VaultKey**: 用于加密业务数据的主密钥：
  - 随机生成的256-bit密钥
  - 仅驻留于内存
  - 由KEK加密后持久化为KeySlot

- **KeySlot**: 加密后的VaultKey的持久化形式：
  - 使用主密码派生的KEK加密
  - 存储在本地
  - 用于在应用启动时解密并获取VaultKey

## Success Criteria *(mandatory)*

### Measurable Outcomes

**功能完整性**：

- **SC-001**: 用户可以在3分钟内完成从创建网站、添加账号到查看账号的完整流程
- **SC-002**: 用户可以在10秒内通过搜索找到特定账号（在100个账号的数据集中）
- **SC-003**: 用户可以在5秒内生成并接受一个强密码

**数据安全性**：

- **SC-004**: 100%的敏感数据（账号、密码）在存储时经过AES-256-GCM加密
- **SC-005**: 在未输入正确主密码的情况下，攻击者无法读取任何业务数据（通过尝试直接读取存储文件验证）
- **SC-006**: 修改主密码操作在1秒内完成（无需重新加密业务数据）

**用户体验**：

- **SC-007**: 90%的用户在首次使用时能够在无帮助文档的情况下成功添加第一个账号
- **SC-008**: 用户在误删账号后，可以在30秒内从回收站恢复
- **SC-009**: 分页加载响应时间低于1秒（在1000个账号的数据集中）
- **SC-010**: 搜索响应时间低于0.5秒（在1000个账号的数据集中）

**数据完整性**：

- **SC-011**: 删除网站操作不会留下孤立的账号数据（100%的关联账号被清理）
- **SC-012**: 软删除的账号在默认列表中100%隐藏，但在回收站中100%可见
- **SC-013**: 用户无法意外删除有活跃账号的网站（阻止率100%）

**性能可扩展性**：

- **SC-014**: 系统可以流畅管理至少1000个账号而无明显性能下降
- **SC-015**: 应用启动并解锁（输入主密码）的时间少于3秒

## Assumptions & Dependencies *(optional)*

### Assumptions

1. **单用户本地应用**: 系统设计为单用户在单设备上使用，不考虑多用户或多设备同步
2. **前后端分离架构**: 系统采用React前端 + .NET Web API后端的分离架构，支持本地部署和运行
3. **无网络依赖**: 所有数据处理和存储都在本地进行，不依赖云服务或网络连接
4. **主密码强度**: 假设用户会选择足够强度的主密码（系统可提供强度检查，但不强制）
5. **数据保留**: 回收站中的账号无过期自动清理机制，由用户手动管理
6. **重复域名**: 允许创建多个相同域名的网站条目（用于区分测试/生产等环境）
7. **标签系统**: 标签为自由文本输入，无预定义标签库，允许重复和任意命名
8. **分页数量**: 默认每页10条是合理的默认值，系统不提供用户自定义每页条数的功能（MVP阶段）
9. **搜索算法**: 搜索使用简单的子串匹配，不使用复杂的模糊搜索或权重排序
10. **加密算法可用性**: 假设运行环境支持Argon2id KDF和AES-256-GCM加密算法

### Dependencies

1. **操作系统加密API**: 依赖操作系统提供的安全随机数生成器（用于生成VaultKey）
2. **加密库**: 需要集成支持Argon2id KDF和AES-256-GCM的加密库
3. **本地存储**: 依赖操作系统的文件系统或本地数据库（如SQLite）来持久化加密数据

## Out of Scope *(optional)*

以下功能不包含在本MVP范围内：

1. **多设备同步**: 不支持在多个设备间同步数据
2. **云备份**: 不提供云端备份功能
3. **账号分享**: 不支持将账号信息分享给其他用户
4. **浏览器扩展**: 不提供浏览器插件自动填充功能
5. **生物识别解锁**: 不支持指纹、面容识别等生物识别方式解锁
6. **密码历史**: 不记录密码修改历史
7. **密码到期提醒**: 不提供密码过期或定期修改提醒
8. **批量导入/导出**: 不支持从其他密码管理器批量导入或导出数据
9. **高级搜索**: 不支持正则表达式、布尔逻辑等高级搜索语法
10. **审计日志**: 不记录用户操作的详细审计日志
11. **账号健康检查**: 不检查密码强度、重复使用或泄露情况
12. **两步验证存储**: 不支持存储和管理2FA令牌
13. **自定义字段**: 账号信息仅支持预定义字段，不支持用户自定义字段
14. **主题定制**: 不提供界面主题或颜色定制
15. **多语言**: 仅支持中文界面
