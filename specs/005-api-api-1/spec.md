# Feature Specification: API密钥管理与外部API服务

**Feature Branch**: `005-api-api-1`
**Created**: 2025-10-16
**Status**: Draft
**Input**: User description: "API密钥管理与外部API服务：1. API密钥管理(无需脱敏显示,可随时查看明文) 2. 账号启用/禁用功能(新增状态字段,与删除是两个独立动作,启用和禁用的账号都在列表显示) 3. 对外接口：创建账号、删除账号、启用/禁用账号、随机获取启用状态的账号 4. Account表新增扩展字段(JSON格式),网页和API都支持扩展字段的读写"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - API密钥管理 (Priority: P1) 🎯 MVP

用户需要创建API密钥以便外部系统或脚本能够调用AccountBox的API接口。用户可以为API密钥指定访问范围：要么访问所有网站的账号数据,要么只访问特定网站的账号数据。API密钥的明文可以随时在UI中查看,方便用户在需要时复制使用。

**Why this priority**: 这是提供对外API服务的基础前提。没有API密钥管理,就无法安全地提供外部API服务。API密钥的作用域控制(全部网站vs指定网站)是核心安全功能,可以防止权限泄露。与传统的"仅显示一次"不同,本系统允许随时查看,更符合个人密码管理工具的使用场景。

**Independent Test**: 用户可以独立测试API密钥的创建、查看、删除功能。验证：(1) 创建API密钥时可以选择"所有网站"或"指定网站"；(2) 创建后可以在列表中随时点击"查看"按钮查看密钥明文；(3) 可以复制密钥明文到剪贴板；(4) 可以删除不再使用的API密钥。

**Acceptance Scenarios**:

1. **Given** 用户已登录并进入API密钥管理页面，**When** 点击"创建API密钥"按钮，**Then** 打开创建对话框,显示名称输入框和作用域选择器(单选框:"所有网站" 或 "指定网站")
2. **Given** 用户选择"所有网站"作为作用域，**When** 填写密钥名称并提交，**Then** 系统生成API密钥并显示在列表中,密钥值显示为明文或提供"显示/隐藏"切换按钮
3. **Given** 用户选择"指定网站"作为作用域，**When** 从多选下拉列表中选择3个网站并提交，**Then** 系统生成API密钥,仅授权该密钥访问这3个网站的账号数据
4. **Given** 用户在API密钥列表页面，**When** 查看某个密钥，**Then** 可以看到密钥明文,点击"复制"按钮可将密钥复制到剪贴板
5. **Given** 用户已创建5个API密钥，**When** 访问API密钥列表页面，**Then** 显示所有密钥的名称、作用域描述(所有网站 / "网站A、网站B、网站C")、创建时间、最后使用时间
6. **Given** 用户在API密钥列表页面，**When** 点击某个密钥的"删除"按钮并确认，**Then** 该密钥被删除,后续使用该密钥调用API会返回401未授权错误

---

### User Story 2 - 账号启用/禁用功能 (Priority: P2)

用户需要能够标记某个账号为"已禁用"状态,而不删除它。启用和禁用是独立于删除的两个操作：删除将账号移入回收站,而禁用只是改变账号的状态标记。所有账号(无论活跃还是禁用)都在账号列表中显示,但禁用的账号有明显的视觉标识。这为账号生命周期管理提供了更灵活的控制。

**Why this priority**: 这是核心数据管理功能的增强。禁用功能与删除功能是两个独立的维度：禁用表示"暂时不使用",删除表示"移入回收站"。两者可以独立操作,甚至可以同时存在(如禁用的账号也可以被删除)。此功能独立于API服务,也服务于UI用户。

**Independent Test**: 在账号列表页面,用户可以独立测试账号的禁用和启用操作。验证：(1) 点击"禁用"按钮后,账号状态变为"已禁用",在列表中显示但有视觉区分；(2) 已禁用账号仍然可以查看、编辑；(3) 点击"启用"按钮后,账号恢复活跃状态；(4) 禁用的账号也可以被删除(移入回收站)。

**Acceptance Scenarios**:

1. **Given** 用户在某网站的账号列表页面,当前有10个活跃账号，**When** 点击某账号的"禁用"按钮，**Then** 该账号状态变为"已禁用",仍然在列表中显示但用灰色背景或禁用图标标识,活跃账号计数显示为9
2. **Given** 账号列表中有3个已禁用账号、7个活跃账号，**When** 用户查看列表，**Then** 所有10个账号都显示在列表中,已禁用账号用灰色背景或特殊图标标识
3. **Given** 用户查看某个已禁用的账号，**When** 点击"编辑"按钮，**Then** 可以正常编辑账号信息(用户名、密码、备注、扩展字段等)
4. **Given** 用户在账号列表中，**When** 点击某个已禁用账号的"启用"按钮，**Then** 该账号恢复活跃状态,视觉标识移除
5. **Given** 用户在账号列表中，**When** 点击某个已禁用账号的"删除"按钮并确认，**Then** 该账号被移入回收站(禁用和删除是两个独立操作)
6. **Given** 用户从回收站恢复了一个之前被删除的账号，**When** 账号恢复后，**Then** 账号保持删除前的状态(如果删除前是禁用状态,恢复后仍是禁用;如果删除前是活跃,恢复后仍是活跃)

---

### User Story 3 - 账号扩展字段管理 (Priority: P3)

用户需要为账号存储额外的自定义信息,这些信息可能因网站而异。系统提供一个扩展字段(JSON格式),允许用户在UI中添加、编辑、删除任意键值对,例如存储"安全问题答案"、"绑定手机号"、"注册邮箱"等信息。外部API也支持读写扩展字段。

**Why this priority**: 扩展字段提供了灵活性,避免为每个可能的字段都创建数据库列。用户可以根据实际需求存储任意结构化数据。此功能是数据模型的基础增强,需要在API功能之前实现。

**Independent Test**: 在账号编辑页面,用户可以独立测试扩展字段的添加、编辑、删除。验证：(1) 可以添加新的键值对(如"邮箱": "user@example.com")；(2) 可以编辑已有的键值对；(3) 可以删除键值对；(4) 扩展字段以JSON格式存储在数据库中。

**Acceptance Scenarios**:

1. **Given** 用户在创建新账号时，**When** 展开"扩展字段"部分，**Then** 显示一个键值对编辑器,可以添加自定义字段(如"安全问题": "母亲姓名")
2. **Given** 用户在扩展字段编辑器中添加了3个键值对，**When** 保存账号，**Then** 扩展字段以JSON格式存储,查看账号时可以看到这3个字段
3. **Given** 用户查看某个账号的扩展字段，**When** 点击"编辑"并修改某个字段的值，**Then** 修改后的值被保存
4. **Given** 用户在扩展字段编辑器中，**When** 删除某个键值对，**Then** 该字段从扩展字段中移除
5. **Given** 用户为某账号设置了扩展字段`{"email": "test@example.com", "phone": "123456"}`，**When** 通过API查询该账号，**Then** 响应中包含完整的扩展字段JSON对象
6. **Given** 外部系统通过API创建账号，**When** 请求体中包含扩展字段`{"备注字段": "值"}`，**Then** 系统成功创建账号并保存扩展字段

---

### User Story 4 - 外部API：账号CRUD操作 (Priority: P4)

外部系统可以通过RESTful API接口对账号进行增删改查操作。创建账号时密码不能为空但无需安全强度检测,支持扩展字段。删除账号遵循与UI相同的规则(移入回收站)。启用/禁用账号改变账号状态。所有操作都受API密钥作用域限制。

**Why this priority**: 这是外部API服务的核心CRUD功能,允许自动化工具管理账号全生命周期。由于依赖于User Story 1的API密钥和User Story 3的扩展字段,优先级较低。

**Independent Test**: 使用curl或Postman等工具,携带有效的API密钥调用各个API接口。验证：(1) 创建账号成功并返回账号详情；(2) 启用/禁用账号成功；(3) 删除账号成功并移入回收站；(4) 获取账号列表成功并正确过滤已禁用账号(根据参数)。

**Acceptance Scenarios**:

1. **Given** 外部系统持有作用域为"所有网站"的API密钥，**When** 调用创建账号接口,提供网站ID、用户名、密码(非空)和扩展字段，**Then** 系统成功创建账号,返回201状态码和账号详情(包括扩展字段)
2. **Given** 外部系统调用创建账号接口，**When** 密码字段为空字符串或null，**Then** 系统返回400错误,提示"密码不能为空"
3. **Given** 外部系统调用创建账号接口，**When** 提供的密码为"123"(弱密码)，**Then** 系统仍然成功创建账号,不进行密码强度验证
4. **Given** 外部系统持有作用域为"网站A、网站B"的API密钥，**When** 尝试为网站C创建账号，**Then** 系统返回403错误,提示"API密钥无权访问该网站"
5. **Given** 外部系统调用删除账号接口，**When** 提供有效的账号ID，**Then** 系统将账号移入回收站,返回204状态码
6. **Given** 外部系统调用启用账号接口，**When** 账号当前处于"已禁用"状态，**Then** 系统将账号状态设为"活跃",返回200状态码
7. **Given** 外部系统调用禁用账号接口，**When** 账号当前处于"活跃"状态，**Then** 系统将账号状态设为"已禁用",返回200状态码
8. **Given** 外部系统调用获取账号列表接口，**When** 不带任何过滤参数，**Then** 响应包含所有账号(活跃+禁用),每个账号包含状态字段
9. **Given** 外部系统调用获取账号列表接口，**When** 添加查询参数`status=active`，**Then** 响应仅包含活跃状态的账号
10. **Given** 外部系统调用获取账号列表接口，**When** 添加查询参数`status=disabled`，**Then** 响应仅包含已禁用状态的账号

---

### User Story 5 - 外部API：随机获取启用账号 (Priority: P5)

外部系统可以通过API接口随机获取某个网站下的一个启用状态的账号。这对于自动化测试或轮询使用多个账号的场景非常有用,例如爬虫程序需要随机选择一个可用账号登录目标网站。

**Why this priority**: 这是外部API的便捷功能,避免外部系统自己实现随机选择逻辑。虽然外部系统可以先获取账号列表再随机选择,但提供专门的接口更高效。此功能依赖于User Story 2的状态字段和User Story 4的基础API,因此优先级最低。

**Independent Test**: 使用curl或Postman等工具,携带有效的API密钥多次调用随机获取接口。验证：(1) 每次调用返回不同的账号(在有多个账号时)；(2) 仅返回启用状态的账号；(3) 当无启用账号时返回404错误。

**Acceptance Scenarios**:

1. **Given** 某网站有5个启用账号和3个禁用账号，**When** 外部系统调用随机获取启用账号接口，**Then** 系统随机返回5个启用账号中的一个,返回200状态码和账号详情
2. **Given** 外部系统多次调用随机获取启用账号接口，**When** 网站有多个启用账号，**Then** 每次调用可能返回不同的账号(随机分布)
3. **Given** 某网站只有禁用账号,没有启用账号，**When** 外部系统调用随机获取启用账号接口，**Then** 系统返回404错误,提示"该网站没有可用的启用账号"
4. **Given** 外部系统持有作用域为"网站A"的API密钥，**When** 调用网站B的随机获取启用账号接口，**Then** 系统返回403错误,提示"API密钥无权访问该网站"
5. **Given** 某网站有10个启用账号，**When** 外部系统在1秒内调用10次随机获取接口，**Then** 每次调用都成功返回(允许返回重复账号,不保证10次全不同)

---

### Edge Cases

- **API密钥泄露**：如果用户的API密钥被泄露,恶意调用者可能滥用API接口。用户可以删除泄露的密钥并创建新密钥(系统不提供密钥轮换功能,直接删除重建即可)
- **API密钥作用域变更**：用户创建API密钥后,是否可以修改其作用域？(假设：不支持修改,需要删除并重新创建)
- **并发请求**：多个外部系统同时使用同一API密钥调用创建账号接口,为同一网站创建同名账号,系统如何处理？(假设：不检查账号名重复,允许创建,由用户自行管理)
- **速率限制**：外部系统是否可以无限制地调用API接口？(假设：初期不实施速率限制,未来可根据需要添加)
- **API密钥过期**：API密钥是否有有效期？(假设：密钥永久有效,除非用户主动删除)
- **禁用账号的编辑**：用户是否可以编辑已禁用的账号(如修改密码、备注、扩展字段)？(假设：可以编辑,禁用只是状态标记,不影响编辑权限)
- **扩展字段验证**：系统是否验证扩展字段的JSON格式或键名？(假设：只验证JSON格式有效性,不限制键名和值类型,由用户自行管理)
- **扩展字段大小限制**：扩展字段JSON的最大大小是多少？(假设：限制为10KB,避免过大的JSON影响性能)
- **随机算法**：随机获取账号使用什么随机算法？(假设：使用均匀随机分布,每个启用账号被选中的概率相等)
- **批量操作**：外部API是否支持批量创建、删除、启用/禁用多个账号？(假设：初期不支持,每次操作一个账号,未来可扩展)
- **禁用账号的密码可见性**：已禁用账号在UI中查看时,是否可以显示密码？(假设：可以,禁用不影响查看权限)
- **回收站中的账号状态**：账号被删除移入回收站后,其状态(启用/禁用)是否保留？(假设：保留,恢复时恢复原状态)

## Requirements *(mandatory)*

### Functional Requirements

**API密钥管理**:

- **FR-001**: 系统必须允许用户创建API密钥,并为每个密钥生成唯一的密钥字符串(如"sk_"前缀 + 32位随机字符)
- **FR-002**: 系统必须允许用户随时在UI中查看API密钥的明文,无需脱敏显示
- **FR-003**: 系统必须提供复制API密钥到剪贴板的功能
- **FR-004**: 系统必须存储API密钥的哈希值用于验证,同时保留明文用于UI显示
- **FR-005**: 用户必须能够为API密钥指定作用域:"所有网站" 或 "指定网站列表"(多选)
- **FR-006**: 系统必须验证API调用时提供的密钥是否有权访问目标网站(基于密钥的作用域)
- **FR-007**: 系统必须允许用户删除不再使用的API密钥
- **FR-008**: 系统必须在API密钥列表中显示每个密钥的名称、作用域描述、创建时间、最后使用时间

**账号启用/禁用功能**:

- **FR-009**: 系统必须为Account实体添加"状态"字段,支持"活跃(Active)"和"已禁用(Disabled)"两种状态
- **FR-010**: 用户必须能够在账号列表页面禁用某个账号,禁用后账号仍在列表中显示但有视觉标识
- **FR-011**: 用户必须能够启用已禁用的账号,使其恢复为活跃状态
- **FR-012**: 账号列表必须同时显示所有账号(活跃和禁用),已禁用账号用灰色背景或特殊图标标识
- **FR-013**: 已禁用账号必须仍然可以被查看、编辑、删除,禁用不影响这些操作
- **FR-014**: 账号被删除移入回收站时,必须保留其状态(启用/禁用),恢复时恢复原状态
- **FR-015**: 网站详情必须显示活跃账号数量和已禁用账号数量(分别统计)

**账号扩展字段**:

- **FR-016**: 系统必须为Account实体添加"扩展字段(ExtendedData)"字段,存储JSON格式的自定义数据
- **FR-017**: 用户必须能够在UI中添加、编辑、删除扩展字段的键值对
- **FR-018**: 系统必须验证扩展字段的JSON格式有效性,无效时拒绝保存
- **FR-019**: 扩展字段的大小必须限制在10KB以内
- **FR-020**: 外部API创建或更新账号时,必须支持读写扩展字段

**外部API：账号CRUD操作**:

- **FR-021**: 系统必须提供RESTful API接口,允许外部系统创建账号(包含用户名、密码、扩展字段等)
- **FR-022**: API接口必须验证请求中包含有效的API密钥,无密钥或密钥无效时返回401错误
- **FR-023**: API接口必须验证API密钥是否有权访问目标网站,无权限时返回403错误
- **FR-024**: API接口创建账号时,密码字段不能为空,为空时返回400错误
- **FR-025**: API接口创建账号时,不进行密码长度或安全强度验证,直接存储到数据库
- **FR-026**: API接口成功创建账号后,返回201状态码和账号详情(包括扩展字段)
- **FR-027**: 系统必须提供API接口删除账号,遵循与UI相同的规则(移入回收站)
- **FR-028**: 系统必须提供API接口启用或禁用账号,改变账号状态
- **FR-029**: 系统必须提供API接口获取账号列表,支持按状态过滤(status=active/disabled)
- **FR-030**: API接口获取账号列表时,默认返回所有账号(活跃+禁用),包含状态字段

**外部API：随机获取启用账号**:

- **FR-031**: 系统必须提供API接口随机返回某网站下的一个启用状态账号
- **FR-032**: 随机算法必须使用均匀分布,每个启用账号被选中概率相等
- **FR-033**: 当网站无启用账号时,接口必须返回404错误,提示"该网站没有可用的启用账号"

**通用安全要求**:

- **FR-034**: 所有API接口必须使用HTTPS协议(生产环境)
- **FR-035**: 系统必须记录所有API调用日志,包括API密钥ID、调用时间、操作类型、目标资源
- **FR-036**: API接口必须返回标准的HTTP状态码和错误消息(如400、401、403、404、500等)

### Key Entities

- **ApiKey(API密钥)**: 表示用户创建的API密钥,包含密钥明文、密钥哈希值、名称、作用域类型(全部/指定)、关联的网站列表、创建时间、最后使用时间
- **Account(账号)**: 扩展现有的账号实体,添加两个新字段：
  - 状态字段(Status): 枚举类型,支持"活跃(Active)"和"已禁用(Disabled)"
  - 扩展字段(ExtendedData): JSON类型,存储自定义键值对,最大10KB
- **ApiKeyWebsiteScope(API密钥网站作用域)**: 当API密钥作用域为"指定网站"时,记录该密钥可访问的网站列表(多对多关系)

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户可以在30秒内完成API密钥的创建,包括选择作用域
- **SC-002**: 用户可以随时在5秒内找到并复制某个API密钥的明文
- **SC-003**: 用户禁用或启用账号的操作响应时间低于1秒,状态变更立即反映在UI中
- **SC-004**: 所有账号(活跃和禁用)都在列表中显示,用户可以在3秒内识别出已禁用账号(通过视觉标识)
- **SC-005**: 用户可以在60秒内为账号添加3个扩展字段键值对并保存成功
- **SC-006**: 外部系统通过API创建账号的成功率达到99%(假设网络正常、参数正确)
- **SC-007**: API接口调用的平均响应时间低于500毫秒(在正常负载下)
- **SC-008**: 系统支持至少100个并发API请求而不出现性能下降
- **SC-009**: API密钥作用域验证的准确率为100%,未授权的API调用100%返回403错误
- **SC-010**: 随机获取启用账号接口在有10个启用账号时,连续调用100次,每个账号被选中的次数在5-15次之间(近似均匀分布)
- **SC-011**: 扩展字段JSON格式验证的准确率为100%,无效JSON 100%被拒绝并返回明确错误消息
- **SC-012**: API接口的错误消息清晰明了,95%的开发者能够根据错误消息快速定位问题
